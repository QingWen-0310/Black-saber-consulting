---
title: "Statistical Analysis Regarding Black Saber Company Employment"
author: "Report prepared for Black Saber Software by ProDasta Consulting Company"
date: '2021-04-21'
output:
  pdf_document:
    template: report.tex
    toc: yes
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
lang: en
subtitle: hiring process and employees' benefits
titlepage: yes
titlepage-color: 51c6b9
titlepage-text-color: FFFFFF
titlepage-rule-color: FFFFFF
titlepage-rule-height: 2
---

```{r, message = FALSE, echo = FALSE}
library(tidyverse)
library(lme4)
library(knitr)
library(lmtest)

# this should supress all code and messages
knitr::opts_chunk$set(echo=FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 3.5)
```

```{r}
# read in the data
curr_employee <- read_csv("data/black-saber-current-employees.csv")
hire_phase1 <- read_csv("data/phase1-new-grad-applicants-2020.csv")
hire_phase2 <- read_csv("data/phase2-new-grad-applicants-2020.csv")
hire_phase3 <- read_csv("data/phase3-new-grad-applicants-2020.csv")
hire_final <- read_csv("data/final-hires-newgrad_2020.csv")
```


# General comments (you can delete this section)

_You can delete this section, and if you want to check what it said, just open a template from the package again. You don't have to use this particular template, but you DO need to write you report in RMarkdown and include a cover page._

_The cover page must have:_

*	_A title and subtitle_
* _"Report prepared for Black Saber Software by" your company name_
*	_Date (assessment submission date is fine)_

_You can change the colour of this cover to any colour you would like by replacing 6C3082 in the YAML above (line 11) to another hex code. You could use this tool to help you:_ https://htmlcolorcodes.com/color-picker/

\newpage
# Executive summary

_Guidelines for the executive summary:_

* _No more than two pages_
* _Language is appropriate for a non-technical audience_
* _Bullet points are used where appropriate_
*	_A small number of key visualizations and/or tables are included_
*	_All three research questions are addressed_


\newpage
# Technical report
_This part of the report is much more comprehensive than the executive summary. The audience is statistics/data-minded people, but you should NOT include code or unformatted R output here._


## Introduction 
#what the report will cover
#setting scope and expectations
As it is requested by the Black Saber Consulting Company due to the worry of potential biases existed within their employee's benefits and hiring process, 
the following report will be analyzing the data given by Black Saber Consulting Company regarding their company potential biases within hiring and remuneration processes. The report includes an abstract, data exploration, data analysis, model building, executive summary, result and conclusions. The study is built upon five data sets from Black Saber Consulting Company of different phases: three hiring phases, the final hires, and the current employee information. The report is done through the software R-studio and JupyterHub. In the data explore section, the data shall be examined at first to check for correlations and potential variables to be used for data analysis and model building section. The statisticians choose the best fitted model and explain in the model building section. Finally the result section includes graphs and plots of the final evidence to answer the raised research question, which will be answered in the conclusion section. The report is confidential and will solely be used for the Black Saber Consulting Company only.


### Research questions

- Is gender a significant determinant of being a successful applicant in each hiring phase?

- Does gender affect how many promotions an employee during its employment?

- Is the amount of salary determined based only on the talents and performance of the employees?


## Is gender a significant determinant of being a successful applicant in each hiring phase?

### Data and exploratory analysis

#### Variables

- *cover_letter*: categorical, whether the applicant submitted a cover letter
- *cv*: categorical, whether the applicant submitted a CV
- *gpa*: numerical, applicant's GPA at school on scale of 4.0
- *gender*, categorical, applicant's gender, including man, woman and prefer not to say
- *extracurriculars*: number of extracurricular activities the applicant have
- *work_experience*: number of work experiences the applicant have

```{r}
# add indicator variables of whether the applicant passed phase-I
success <- hire_phase2$applicant_id
hire_phase1 <- hire_phase1 %>% 
  mutate(pass = ifelse(applicant_id %in% success, 1, 0))

# add indicator variables of whether the applicant passed phase-II
success_2 <- hire_phase3$applicant_id
hire_phase2 <- hire_phase2 %>% 
  mutate(pass = ifelse(applicant_id %in% success_2, 1, 0))

# add indicator variable of whether the applicant passed phase-III
success_3 <- hire_final$applicant_id
hire_phase3 <- hire_phase3 %>% 
  mutate(pass_final = ifelse(applicant_id %in% success_3, 1, 0))
```

Table 1: Conditional probability table for the three phases of hiring

\begin{table}[]
\begin{tabular}{|c|c|c|c|c|c|c|}
\hline
Gender            & \multicolumn{2}{c|}{Phase 1} & \multicolumn{2}{c|}{Phase 2} & \multicolumn{2}{c|}{Phase 3} \\ \hline
                  & Does not pass     & Pass     & Does not pass     & Pass     & Does not pass     & Pass     \\ \hline
Man               & 0.467             & 0.483    & 0.468             & 0.682    & 0.583             & 0.800    \\ \hline
Prefer not to say & 0.026             & 0.010    & 0.011             & 0.000    &                   &          \\ \hline
Woman             & 0.508             & 0.507    & 0.522             & 0.318    & 0.417             & 0.200    \\ \hline
\end{tabular}
\end{table}

```{r, fig.cap="Proportion of people passed phase I by gender and cv"}
hire_phase1_temp <- hire_phase1 %>% 
  mutate(cover_letter = as.factor(ifelse(cover_letter == 0, "Not submitted", "Submitted"))) %>% 
  mutate(cv = as.factor(ifelse(cv == 0, "No CV", "Have CV"))) %>% 
  mutate(pass = as.factor(ifelse(pass == 0, "No", "Yes")))

# proportion of successful applicants within each sex group
hire_phase1_temp %>% 
  ggplot(aes(x = cv, fill = as.factor(pass))) +
  geom_bar(position = "fill") +
  facet_wrap(~gender) +
  scale_fill_manual(values = c("#fa8154", "#51c6b9")) +
  ylab("Proportion") +
  theme_minimal() +
  labs(fill = "Pass", x = "CV submission", y = "Proportion")
```

```{r, fig.cap="Proportion of people passed phase I by gender and cover letter"}
# proportion of successful applicants vs. gender and cover letter
hire_phase1_temp %>% 
  ggplot(aes(x = cover_letter, fill = as.factor(pass))) +
  geom_bar(position = "fill") +
  facet_wrap(~gender) +
  scale_fill_manual(values = c("#fa8154", "#51c6b9"))+
  ylab("Proportion") +
  theme_minimal() +
  labs(fill = "Pass", x = "Cover letter submission", y = "Proportion")
```

```{r, fig.cap="Proportion of people passed phase I by gender and extracurriculars"}
# proportion of successful applicants vs. gender and work experience
hire_phase1_temp %>% 
  ggplot(aes(x = extracurriculars, fill = as.factor(pass))) +
  geom_bar(position = "fill") +
  facet_wrap(~gender) +
  scale_fill_manual(values = c("#fa8154", "#51c6b9"))+
  ylab("Proportion") +
  theme_minimal() +
  labs(fill = "Pass", x = "extracurricular", y = "Proportion")
```

By looking at the data for each phase, we can figure out which applicants successfully passed the previous phase by looking at the common *id*s between two phases. For instance, applicants included in the phase II data set are the ones who passed phase I. Following this logic, we create a new variable in each phase that takes value of 1 if the candidate passed this phase, and 0 otherwise. 

After creating the indicator variable, we then looked at the proportion of different gender passing each phase. Referring to *Table 1*, in phase I, 48.3% male, 50.7% female, and 1% prefer not to say passed this phase. There seems to be an even split between males and females who successfully passed the phase. Moving on to phase II, the split between males and females become a bit uneven, as among all those passed the phase, 68.2% are males while 31.8% are females, with 0% of prefer not to say. Lastly, in phase III, the ratio of males to females who passed this phase becomes 4:1. This preliminary observation leads us to think whether the selection algorithm is based solely on candidates' skills, or does gender affects the probability of a candidate being selected as successful candidate? If gender does play a role, then how big is the impact?

To investigate the question, we drew out some exploratory plots. We found that in the phase I selection, all the candidates who did not submit a *CV* or a *cover letter*, or did not have any *extracurriculars* did not pass phase I, as *Figure 1*, *Figure 2*, and *Figure 3* shows. Hence, if a candidate did not submit these two files or does not have any extracurriculars, then other potential determinants for success like *GPA* and *work experience* become irrelevant in determining whether the candidate passes the current phase. Therefore, we decide to filter out the observations that do not have a CV/cover letter present in phase I, which reduces out sample size from 613 observations to 355 observations. Even though there is a large reduction in the sample size, we think the manipulation is necessary as we can investigate how other factors play a role in the selection process. 

### Method

For phase-I data, we mainly utilize summary tables and visualizations to determine whether there is a potential gender bias during the selection process. 

For phase-II data, we know that the AI focuses on the four skills that the candidates possess, so we build a model to see which factors are important in this phase. Since we have a binary response of whether each candidate passed phase-II, we lean on adopting a logistic regression model. To check the assumptions for the logistic regression model, we start by looking at our observations, which are all independent of each other. With a logit link, we expect there to be a linear relationship among the explanatory variables and the transformed response. Hence, we include each candidate's scores on *technical skills*, *writing skills*, *leadership presence* and *speaking skills* as our predictors in the model. With the predictors and response specified, the model can be written out as follows: $$log(\frac{\mu_2}{1-\mu_2}) = \beta_0 + \beta_1 *\text{Technical skills} + \beta_2 *\text{Writing skills} + \beta_3 * \text{Leadership presence} + \beta_4 * \text{Speaking skills}$$ 

$\mu$: the probability of a candidate passing phase-II
$\beta_i$: coefficient for each variable

Finally, in phase-III of the hiring, the candidates have two interviews with two interviewers. The HR team will then decide which candidates to hire based on the interview scores. Due to a limited number of observations in the final phase, and a relatively small number of variables, we decide to use summary tables and visualizations to draw on conclusions.

### Results

#### Phase-I

```{r}
# filter out observations without cv or cover letter
hire_phase1_filtered <- hire_phase1 %>%
  filter(cv == 1) %>%
  filter(cover_letter == 1)
```

Table 2: Proportion of candidates passing Phase-I by gender with filtered observations

|                   | Does not pass | Pass |
|-------------------|---------------|------|
| Man               | 0.47          | 0.48 |
| Prefer not to say | 0.02          | 0.01 |
| Woman             | 0.51          | 0.51 |


```{r}
h1f_male <- hire_phase1_filtered %>% 
  filter(gender == "Man")
h1f_female <- hire_phase1_filtered %>% 
  filter(gender == "Woman")
h1f_pns <- hire_phase1_filtered %>% 
  filter(gender == "Prefer not to say")
# summary(h1f_female)
# summary(h1f_male)
# summary(h1f_pns)

gen <- c("Man", "Woman", "Prefer not to say")
num <- c(171, 180, 4)
gpa_median <- c(3.00, 3.00, 2.40)
extra_median <- c(1.00, 1.00, 1.00)
work_median <- c(1.00, 1.00, 1.00)

sum_filtered_table <- data_frame(gen, num, gpa_median, extra_median, work_median)
colnames(sum_filtered_table) <- c("Gender", "Number", "GPA", "Extracurricular", "Work experience")
kable(sum_filtered_table, caption = "Median statistics by gender")
```

From *Table 2*, we see that among those candidates who successfully passed Phase-I, 48% of them are male and 51% of them are female, with the rest 1% having a gender of "prefer not to say". Hence, from the table summary, it seems that the Phase-I hiring is pretty fair across genders. 

*Table 3* displays the median statistics for *GPA*, number of *Extracurricular*, and the number of *Work experience* the candidates have by gender. There is a relatively even split between the number of *male* and *female* candidates, while *prefer not to say* only has 4 candidates. Despite this, the median values for each of the variables seem to be pretty consistent across different genders. The only discrepancy appears to be *prefer not to say* having a lower *GPA* than the other two genders, potentially due to the small number of observations. 


#### Phase-II

```{r}
# build model
hire2_mod <- glm(pass~technical_skills + writing_skills + leadership_presence + speaking_skills, family = binomial(), data = hire_phase2)

hire2_ci <- confint(hire2_mod)

# table for reporting
ests_h2 <- format(round(exp(summary(hire2_mod)$coef)[, 1], 2), nsmall = 2)
cis_h2 <- round(exp(hire2_ci), 2)
cis_h2 <- str_c("(", trimws(cis_h2[, 1]), ", ", cis_h2[, 2], ")")
pval_h2 <- round(summary(hire2_mod)$coefficients[, 4], 4)
hire2_rownames <- c("Baseline odds", "Technical skills", "Writing skills", "Leadership_presence", "Speaking_skills")

hire2_colnames <- c("Estimates", "95% CI", "P-value")

hire2_mod_table <- cbind(ests_h2, cis_h2, pval_h2)
rownames(hire2_mod_table) <- hire2_rownames
colnames(hire2_mod_table) <- hire2_colnames
knitr::kable(hire2_mod_table, align = c("r", "r"), caption = "Coefficient estimates for the logistic model built for hiring phase-II")
```

```{r}
# hire2_mod_wg <- glm(pass~gender + technical_skills + writing_skills + leadership_presence + speaking_skills, family = binomial(), data = hire_phase2)
# 
# lmtest::lrtest(hire2_mod, hire2_mod_wg)
```

From the results, we see that the effect of all four predictors are significantly positive, with the odds ratio for *technical skills*, *writing skills*, *leadership presence*, and *speaking skills* being 1.08, 1.09, 2.53, and 2.01. The p-values for the 4 predictors are all significant. Taking the odds ratio of *technical skills* as an example, it means that with a 1 unit increase in *technical skills*, the odds of being a successful candidate in phase-II is 1.08 times higher. 

To investigate whether gender plays a significant role in the phase-II selection, we include *gender* as our predictor in addition to the original four. Then, by performing a Likelihood ratio test, we found that the p-value is around 0.41, suggesting that we lean more towards the simpler model that does not include *gender* as one of its predictors. 

#### Phase-III

```{r, fig.cap="Histogram of the total scores vs. whether the candidate with the score passed phase-III"}
hire_2_3 <- hire_phase3 %>% 
  mutate(total = interviewer_rating_1 + interviewer_rating_2)%>% 
  mutate(`Pass` = as.factor(ifelse(pass_final == 1, "Yes", "No"))) %>% 
  arrange(desc(total)) %>% 
  left_join(hire_phase2, by = "applicant_id") %>% 
  select(applicant_id, gender, total, `Pass`)

hire_2_3 %>% 
  ggplot(aes(x = total, fill = `Pass`)) +
  geom_histogram(color = "white") +
  theme_minimal() +
  scale_fill_manual(values = c("#fa8154", "#51c6b9")) +
  labs(x = "Total score") + 
  facet_wrap(~gender)
```


```{r}
hire2_temp <- hire_phase2 %>% 
  filter(applicant_id == 1600 | applicant_id == 3560) %>% 
  select(applicant_id, gender, technical_skills, writing_skills, leadership_presence, speaking_skills)
colnames(hire2_temp) <- c("Applicant id", "Gender", "Technical skills", "Writing skills", "Leadership presence", "Speaking skills")

knitr::kable(hire2_temp, caption = "Phase-II information for the two applicants with a tie in phase III")
```

*Figure 2* shows the distribution of the total scores earned by candidates which is constructed from summing up the two *interview ratings*. From the plot, we see that most candidates with the highest scores are recruited. However, there are two candidates with a total score of 153, where only one of them is recruited who is a male. Hence, to explore further, we went back to the phase-II data and filter out these two observations and summarize the scores obtained by these two candidates in **Table X**. From the table, the female candidate have higher scores in *writing skills*, *leadership presence*, and *speaking skills* than the male candidate does. On the other hand, the male candidate has higher scores in *technical skills* than the female candidate does.

### Conclusions

As *Table 4* shows, the male has higher scores in *technical skills*, while the female is better at categories like *writing skills*, *leadership presence*, and *speaking skills*. According to our phase-II model, *leadership presence* and *speaking skills* seems to have larger effect on the odds ratio than the other two determinants do. So, we would expect the female to be selected as a successful candidate instead of the male. 

In both Phase I and Phase II, we fit generalized linear models on different variables in each phase, and use likelihood ratio tests to find out whether gender plays an important role in passing rate. In phase I, we assess the impact of GPA, extracurricular activities and work experiences on passing status; for phase II, technical skills, writing skills, leadership presence and speaking skills are considered. Analyzing their odds ratios, these variables all have remarkable effects on whether candidates go to the next round smoothly. On the other hand, variable gender does not play a role here. The fitted models and the likelihood ratio tests tell us that gender does not have a noticeable impact on the final result, we tend to choose a simpler model that excludes the impact of gender here. Therefore, we do not think gender is a significant determinant of being a successful applicant in each hiring phase.

## Promotion process
##Does gender affect how many promotions an employee during its employment?

Creating and checking the y-variable:
```{r}
cleaned_data <- curr_employee
#cleaned_data <- cleaned_data%>%
#  group_by(employee_id) %>%
#  count()
cleaned_data <- cleaned_data%>%
  mutate(role_seniority, role_num =case_when(
    role_seniority == "Entry-level"~1,
    role_seniority == "Junior I"~2,
    role_seniority == "Junior II"~3,
    role_seniority == "Senior I"~4,
    role_seniority == "Senior II"~5,
    role_seniority == "Senior III"~6,
    role_seniority == "Manager"~7,
    role_seniority == "Director"~8,
    role_seniority == "Vice president"~9,
    ))

get_promoted=c(0)
for (n in 1:6905){
   if (cleaned_data$employee_id[n] == cleaned_data$employee_id[n+1]){
     if (cleaned_data$role_num[n] == cleaned_data$role_num[n+1]){
       get_promoted[n+1] = 0
     }
     else{
       get_promoted[n+1] = 1
     }
   }
  else{
    get_promoted[n+1]=0
  }
}
cleaned_data$get_promotion = get_promoted

table_promotion = table(cleaned_data$get_promotion)

cleaned_data <- cleaned_data%>%
  filter(gender!="Prefer not to say")
```



## make data tidy
```{r}
tidy_data <- slice(cleaned_data, 0)
for (n in 2:6789){
   if (cleaned_data$employee_id[n] == cleaned_data$employee_id[n-1]){
       tidy_data[nrow(tidy_data)+1,]=list(cleaned_data$employee_id[n], cleaned_data$gender[n], cleaned_data$team[n], cleaned_data$financial_q[n],
                       cleaned_data$role_seniority[n],cleaned_data$leadership_for_level[n],cleaned_data$productivity[n],cleaned_data$salary[n],
                       cleaned_data$role_num[n],cleaned_data$get_promotion[n])
   }
}
```

```{r}
tidy_data<-tidy_data %>%
  mutate(role_seniority=fct_relevel(role_seniority,"Director",after = 7))
```


### Methods

## explore data
```{r}
tidy_data %>% 
  ggplot(aes(x = productivity,y=leadership_for_level, color = gender)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(~role_seniority)
```

```{r}
## focus on observations only where employees are getting promoted
data_promotion<-tidy_data%>%
  filter(get_promotion==1)

data_promotion %>% 
  ggplot(aes(x = productivity,y=leadership_for_level, color = gender)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(~role_seniority)
```
observation: for those getting promoted, only males receive the feedback of leadership as "exceeds expectation" and almost no one(except one female at junior II) receive feedback of "needs improvement" can get promotion.So here might be one potential outlier.

2. Summaries of the categorical variables
```{r}
unique(tidy_data$role_seniority)
unique(tidy_data$team)
unique(tidy_data$employee_id)
```
there are nine levels, eight teams and 579 employees(already excluding people who filled in "prefer not to say" ) 


```{r}
## get an approximate threshold of promoting productivity requirement seperately for each gender and also different role level
data1<-tidy_data%>%
  filter(get_promotion==1)%>%
  group_by(role_seniority,gender,leadership_for_level)%>%
  summarise(avg_productivity=mean(productivity),counts=n())
data1
```

```{r}
data1 %>% 
  ggplot(aes(x = avg_productivity,y=leadership_for_level, color = gender)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(~role_seniority)
```
observation: for appropriate for level, we found that females have a relatively higher average productivity than males did in almost every role level promotion stage.Perhaps it is the indication od existence of interaction between gender and productivity!

```{r}
## vidualization
data2 <- tidy_data %>%
  filter(get_promotion == 1)%>%
  filter(leadership_for_level=="Appropriate for level")

data2%>%
  ggplot( mapping = aes(x = role_seniority, y = productivity,colour=gender)) + 
  geom_boxplot()
```

```{r}
##explore team
data3 <- tidy_data %>%
  filter(get_promotion == 1,leadership_for_level=="Appropriate for level")%>%
  group_by(team,role_seniority,gender,leadership_for_level)%>%
  summarise(avg_productivity=mean(productivity),counts=n())
```
```{r}
data3 %>% 
  ggplot(aes(x = avg_productivity,y=role_seniority, color = gender)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(~team)
```
observation: maybe gender:team as an interactive term???

##check assumption of generalized mixed effect model

1.our subjects(emplyees) are independent 

2.random effects come from a normal distrubution There is an assumption that random effects—both intercepts and slopes—are normally distributed.)

```{r}
qqnorm(curr_employee$employee_id)
qqline(curr_employee$employee_id, col = "orange", lwd=2)
```

From the Quantile-Quantile plot above, the points follow closely around the qq-line in the middle and deviates from it at the two ends. Given this information, the variable "id" can be assumed to be normally distributed, hence matching the model assumption. 

```{r}
cleaned_data <- curr_employee
cleaned_data <- cleaned_data%>%
  mutate(team, team_num =case_when(
    team == "Client services"~1,
    team == "Data"~2,
    team == "Design Legal and financial"~3,
    team == "Marketing and sales"~4,
    team == "Operations"~5,
    team == "People and talent"~6,
    team == "Software"~7  ))

qqnorm(cleaned_data$team_num)
qqline(cleaned_data$team_num, col = "orange", lwd=2)
```

3.the random effects errors and within-unit residual errors have constant variance(are variance of data(transformed by the link function) homogeneous across data)

4.response is bianry
If a logistic link function is appropriate, these plots should be linear, and the stronger the linear association, the more promising the predictor

## initial model
```{r}
##centering parameter
quantile(tidy_data$productivity)
tidy_data$productivityC<-tidy_data$productivity-49
```

```{r}
## 
promotion_model1<-lme4::glmer(get_promotion~gender+leadership_for_level+productivityC+(1|employee_id), data=tidy_data, family = "binomial")
summary(promotion_model1)
```


```{r}
## with interaction term
promotion_model2<-lme4::glmer(get_promotion~gender+leadership_for_level+productivityC+productivityC:gender+(1|employee_id),data = tidy_data,family = "binomial")
lmtest::lrtest(promotion_model1,promotion_model2)
```

```{r}
## with role seniority
promotion_model3<-lme4::glmer(get_promotion ~gender+productivityC+leadership_for_level+productivityC:gender+(1|employee_id),data = tidy_data,family = "binomial")
summary(promotion_model3)
```

```{r}
#promotion_model4<-lme4::glmer(promotion_counts~gender+productivity+leadership_for_level+(1|employee_id),data = data3)
#fixef(salary_mod)
```

### limitation
cannot verify our some of our variables(productivity and leadership_for_level) are biased or not, since we do not know the source of rating
## cannot tell whether leadership for level is biased specially for exceeds expectation/need improvement
```{r}
tidy_data%>%
  ggplot()+
  geom_bar(mapping = aes(x = leadership_for_level, fill = gender), position = "fill")+
  scale_fill_manual(values = c("#fa8154", "#51c6b9")) +
  theme_minimal()
```


## Is the amount of salary determined based only on the talents and performance of the employees?

### Data & exploratory analysis

We reformatted the values of *salary* in the original data set by taking off the "$" and "," and change the values from character values to numeric values for latter analysis. In addition to this, we re-level some factors for better display and ease of understanding. For instance, we re-level the factor of *seniority role* to reflect the ordering of the job title, from the least to the most senior.

```{r}
# salary distribution filled by gender
curr_1 <- curr_employee %>% 
  mutate(salary = str_replace(salary, "\\$", "")) %>% 
  mutate(salary = as.integer(str_replace(salary, ",", ""))) 

# re-level the factor
curr_1 <- curr_1 %>% 
  mutate(gender = fct_relevel(gender, "Prefer not to say", after = 0)) %>% 
  mutate(leadership_for_level = fct_relevel(leadership_for_level, "Needs improvement", after = 0)) %>% 
  mutate(role_seniority = fct_relevel(role_seniority, "Entry-level", after = 0)) %>% 
  mutate(role_seniority = fct_relevel(role_seniority, "Manager", after = 7)) %>% 
  mutate(role_seniority = fct_relevel(role_seniority, "Director", after = 7))

gender <- c("Prefer not to say", "Man", "Woman")
salary_mean <- c(46340, 48491, 45811)
prod_mean <- c(45.47, 48.99, 50.44)

sum_table <- data_frame(gender, prod_mean, salary_mean)
colnames(sum_table) <- c("Gender", "Mean productivity", "Mean salary")
knitr::kable(sum_table, caption = "Mean productivity and mean salary by gender")
```

```{r, fig.cap="Salary vs. gender and leadership for level"}
options("scipen" = 10)
curr_1 %>% 
  ggplot(aes(x = salary, fill = gender)) +
  geom_histogram(color = "white") +
  theme_minimal() +
  scale_fill_manual(values = c("#fa8154", "#FFC300", "#51c6b9")) +
  labs(x = "Salary") +
  facet_wrap(~leadership_for_level) +
  coord_flip() +
  guides(fill = guide_legend(title = "Gender"))

# table(curr_1$gender, curr_1$leadership_for_level)
```

*Table 7* shows the average *productivity* and *salary* by gender. From the table, we see that females possess the highest average productivity of 50.44, but the lowest average salary among the three genders. On the other hand, males have the second highest average productivity of 48.99 and the highest average salary. 

*Figure 6* displays the histogram of *salary* by *gender* and *leadership role*. Looking at the distribution of *salary* by *leadership role*, we see that the distribution is a bit right skewed, which is common as there are usually fewer employees with very high salaries than the ones with lower salaries. One thing worth notice is that the employees that *exceeds expectations* are all males, while the employees that *needs improvement* are all females. Despite this, employees that *exceeds expectations* seem to overall have slightly higher salaries than the employees that *needs improvement* do. 

### Method

Since we have repeated measurement in the data set of all the employees and a continuous response variable: *salary*, we consider fitting a linear mixed model, treating the *ids* for the employees as random effects. The fixed effects we consider fitting in the model are *productivity*, *leadership role*, *seniority role*, and *gender*, as we are interested whether the former three variables help quantify an employee's talents and abilities, while we want to figure out whether *gender* also plays a role in determining an employee's salary. Hence, the model we try to fit can be written out as follows: $$Y_{ij} = \boldsymbol X_{ij} \boldsymbol \beta + \epsilon$$. 

$Y_{ij}$: repeated measures j for salary on individual i, the response variable \
$\boldsymbol X$: model matrix for the fixed effects: *productivity*, *leadership role*, *seniority role*, and *gender* \
$\boldsymbol \beta$: the effect of covariates on the mean outcome \
$\epsilon$: residual errors 

To verify our assumptions for the usage of the model, firstly, we have a continuous response variable. Secondly, we identified *employee id* as our grouping variable resulting from the repeated measurement, so we include this grouping variable as our random effect. Lastly, even though the observations within each subject are not independent, the subjects themselves are independent. 

### Results

```{r}
# model without gender
salary_mod_nog <- lmer(salary ~ productivity + leadership_for_level + role_seniority
                    + (1|employee_id), data = curr_1)
# build the final model
salary_mod <- lmer(salary ~ productivity + leadership_for_level + gender + role_seniority
                    + (1|employee_id), data = curr_1)

# lrtest(salary_mod_nog, salary_mod)
```

**Table X**: Likelihood ratio test results for model with/without gender

|   | #Df | Loglik | Df | Chisq | Pr(>Chisq) |
|---|-----|--------|----|-------|------------|
| 1 | 14  | -58728 |    |       |            |
| 2 | 16  | -58671 | 2  | 114   | <2.2e-16   |


```{r}
# table for reporting
ests_s <- format(round(summary(salary_mod)$coef[, 1], 2), nsmall = 2)
salary_ci <- round(confint(salary_mod)[-c(1:2),], 2)
cis_s <- str_c("(", trimws(salary_ci[, 1]), ", ", salary_ci[, 2], ")")
salary_rownames <- c("Intercept", "Productivity", "Leadership: exceeds expectations", "Leadership: needs improvement", "Gender: man", "Gender: woman", "Junior I", "Junior II", "Senior I", "Senior II", "Senior III", "Manager", "Director", "Vice president")

salary_colnames <- c("Estimates", "95% CI")

salary_mod_table <- cbind(ests_s, cis_s)
rownames(salary_mod_table) <- salary_rownames
colnames(salary_mod_table) <- salary_colnames
knitr::kable(salary_mod_table, align = c("r", "r"), caption = "Model summary for salary")
```

After building models that include *employee id* as only random intercept and random intercept and slope (interacting with *gender*), the likelihood ratio test tells us to adopt the model with only the random intercept (p = 0.9246). 

From *table 8*, we see that the grand average of the salary is 31900.93. Predictors that are significant are: *leadership role: exceeds expectations*, *leadership role: needs improvement*, and all levels of the *seniority role*, since the 95% confidence intervals for these coefficients do not include 0. Among these important covariates, both levels of the *leadership role* have large negative effects, while all levels of the *seniority role* have large positive effects on salary.

To determine whether *gender* plays a significant role in the determination of salary, we compare our current model with a nested model that have the same covariates as in our current model but without *gender*. The result of the model comparison using the likelihood ratio test is presented in table **TODO**. We see that the p-value appears to be really small (< 2.2e-16), so we expect having *gender* to improve our model by a significant amount. 

### Conclusions

*discuss how lrt interacts with our figure of leadership_role by gender*
From the visualizations and model above, the relationship between salary with covariates like productivity, leadership role, seniority role and gender shows that male employees tend to receive more benefits than females do. The visualization **Figure 6** and the proportion on average productivity exhibits unfairness between different genders. Between genders and leadership roles, some females think that salary still needs to be improved, while the male leaders think the opposite, that their benefits have already exceeded their expectations. Moreover, females who have the highest productivity but turn out have the lowest average salary, while the males have lower productivity resulting in a much higher average salary. The result from the linear mixed model we fitted, one with gender as a covariates and one without, the likelihood ratio test shows that gender does play a crucial role in salary. Holding other variables constant, female employees have 2022.17 dollars less than the average salary, while males have 679.10 dollars even more than the average.

There is a slight discrepancy that our likelihood ratio test and 95% confidence interval give us different results. The likelihood ratio test says we should use the one with gender included, but 95% C.I. gives us the opposite as it is insignificant. Based on the evidence from previous proportion tables and visualizations, we tend to believe that there are still some differences when gender comes in, both in hiring processes and employees' benefits.


## Discussion

_In this section you will summarize your findings across all the research questions and discuss the strengths and limitations of your work. It doesn't have to be long, but keep in mind that often people will just skim the intro and the discussion of a document like this, so make sure it is useful as a semi-standalone section (doesn't have to be completely standalone like the executive summary)._

### Strengths and limitations

\newpage
# Consultant information
## Consultant profiles

<<<<<<< HEAD
**Ke Deng**. Ke Deng is a junior analyst at the ProDasta Consulting Company, where she does report writing and data analysis for clients. She graduated from the University of Toronto with a Bachelor degree of Science, and is currently enrolled in the graduate program. Ke specializes in Statistics, with a focus in economics. She has been with the ProDasta Consulting Company since the company started. Ke is currently employed as the report writer and consulter of the company and she is great at writing and polishing reports for the clients.
=======
*This section is only marked for completeness, clarity and professionalism, not 'truth' so you can write it as if we're a few years in the future. Put your current degree in as completed and/or add your first choice grad school program, whatever you like. What skills related skills would you most like to highlight? What job title do you want?*

**Ke Deng**. Ke Deng is a junior analyst at the ProDasta Consulting Company, where she does report writing and data analysis for clients. She graduated from the University of Toronto with a Bachelor degree of Science, and is currently enrolled in the graduate program. Ke specializes in Statistics, with a focus in economics. She has been with the ProDasta Consulting Company since the company started. Ke is currently employed as the report writer and consultant of the company and she is great at writing and polishing reports for the clients.
>>>>>>> 65a6431503dc1738d0253faae49797516bcd54fc

**Wenqing Hao**. Wenqing Hao is an experienced analyst at the ProDasta Consulting Company, also one of the four co-founders  of the Company. She holds a Bachelor degree of Science from the University of Toronto, focusing on both Statistics and Financial economics. She has a strong background of  managing business operations and finance projects. Over the past few years, she cooperates well and closely with the other three co-founders, generating a rather professional team to successfully satisfy clients’ various requests.    

**Qihui Huang**. Qihui Huang, an junior analyst working at ProDasta Consulting Company. Qihui has studied Statistics at University of Toronto for 3 years, and aims to graduate with a Bachelor of Science degree in Statistics. She also has 1 year experience in data related roles. In her study and work, Qihui developed a time management guide to help her co-workers manage stress and emotion. On weekends, she likes to go hiking with her friends or reading books.

**Qing Wen**. Qing, commonly referred to as Chelsea, is an analyst at the ProDasta Consulting Company. She graduated from the University of Toronto with a degree in applied statistics, focusing on economics. Qing joined ProDasta during her pursuit of a graduate degree in business analytics. With 3 years of experience working with clients, Qing handles clients’ requests with her passion and expertise. She enjoys communicating with the clients in casual ways to solve their problems using her outstanding analytical skills, as well as helping colleagues to improve the productivity of the whole team.


## Code of ethical conduct

1. ProDasta Consulting Company seeks to have high professional standards within the development, usage and enforcement and keeps a high standard for having the reputation of statistical practices. We state to do the best of setting standards for the Statistics field and for Statisticians, avoid any wrong actions. 

2. ProDasta Consulting Company and the employees take on the responsibility of work. We refuse to deliver any wrong statements that can cause damage to the professional statistical fields.

3. We support and welcome any statisticians in their professional field. We act with integrity and dignity toward the fellow statisticians, and provide opportunities for them to the professional field. 


